worker_processes  1;
daemon off;
pid        /var/run/nginx/nginx.pid;


events {
    worker_connections  1024;
}


http {
    charset utf-8;
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;



    access_log  /dev/stdout;
    error_log  /dev/stdout debug;
    sendfile        on;
    tcp_nopush     on;
    keepalive_timeout  65;
    gzip  on;
    server {
        listen 9114;
        server_name "locahost";
        location /nginx_status {
            stub_status on;
            access_log off;
        }
    }

    server {                                                                                                               
            listen 80;                                                                        
            server_name "";                                                                                  
            gzip on;                                                                                                       
            gzip_vary on;                                                                                                  
            gzip_min_length 10240;                                                                                         
            gzip_proxied expired no-cache no-store private auth;                                                           
            gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml;              
            gzip_disable "MSIE [1-6]\.";                                                                                   
            root /var/www/gallery;                                                                                         
            index index.html;                                                                                              
            rewrite ^/store/print/[^/]+$ /print.html last;
            rewrite ^/store/success$ /success last;
            rewrite ^/store/cancel$ /cancel last;
            location /img/raw {                                                                                            
                    return 404;                                                                                            
            }                                                                                                              
            location /.git {                                                                                               
                    return 404;                                                                                            
            }                                                                                                              
            location /templates {                                                                                          
                    return 404;                                                                                            
            }                                                                                                              
            location ~ /img/.*\.json$ {                                                                                    
                    return 404;                                                                                            
            }                                                                                                              
            location ~ .*\.py {                                                                                       
                    return 404;                                                                                            
            }                                                                                                              
                                                                                                                           
            location ~* .(jpeg|jpg|http|json|html)$ {                                                                                 
                    expires 2h;                                                                                            
                    add_header Cache-Control "public, max-age=7200";                                                      
            }                                                                                                              
            location /api/print/
            {
                    try_files $uri.json =404;
            }

                                                                                                                           
            location / {                                                                                                   
                    try_files $uri $uri.html $uri/ =404;                                                                   
            }                                                                                                              

            location /api/store {
                    proxy_pass         http://webgallery-store:4280/;
                    proxy_redirect     off;
                    proxy_set_header   Host                 $host;
                    proxy_set_header   X-Real-IP            $remote_addr;
                    proxy_set_header   X-Forwarded-For      $proxy_add_x_forwarded_for;
                    proxy_set_header   X-Forwarded-Proto    $scheme;
            }
    }                                                                                                                      
}

